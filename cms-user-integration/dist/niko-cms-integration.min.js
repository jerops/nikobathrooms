/*! For license information please see niko-cms-integration.min.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NikoCMSIntegration=t():e.NikoCMSIntegration=t()}(this,()=>(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function n(e){return function(e){if(Array.isArray(e))return o(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return o(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?o(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function i(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function s(r,n,o,i){var s=n&&n.prototype instanceof c?n:c,l=Object.create(s.prototype);return a(l,"_invoke",function(r,n,o){var i,a,s,c=0,l=o||[],f=!1,h={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,r){return i=t,a=0,s=e,h.n=r,u}};function d(r,n){for(a=r,s=n,t=0;!f&&c&&!o&&t<l.length;t++){var o,i=l[t],d=h.p,w=i[2];r>3?(o=w===n)&&(s=i[(a=i[4])?5:(a=3,3)],i[4]=i[5]=e):i[0]<=d&&((o=r<2&&d<i[1])?(a=0,h.v=n,h.n=i[1]):d<w&&(o=r<3||i[0]>n||n>w)&&(i[4]=r,i[5]=n,h.n=w,a=0))}if(o||r>1)return u;throw f=!0,n}return function(o,l,w){if(c>1)throw TypeError("Generator is already running");for(f&&1===l&&d(l,w),a=l,s=w;(t=a<2?e:s)||!f;){i||(a?a<3?(a>1&&(h.n=-1),d(a,s)):h.n=s:h.v=s);try{if(c=2,i){if(a||(o="next"),t=i[o]){if(!(t=t.call(i,s)))throw TypeError("iterator result is not an object");if(!t.done)return t;s=t.value,a<2&&(a=0)}else 1===a&&(t=i.return)&&t.call(i),a<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),a=1);i=e}else if((t=(f=h.n<0)?s:r.call(n,h))!==u)break}catch(t){i=e,a=1,s=t}finally{c=1}}return{value:t,done:f}}}(r,o,i),!0),l}var u={};function c(){}function l(){}function f(){}t=Object.getPrototypeOf;var h=[][n]?t(t([][n]())):(a(t={},n,function(){return this}),t),d=f.prototype=c.prototype=Object.create(h);function w(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,a(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return l.prototype=f,a(d,"constructor",f),a(f,"constructor",l),l.displayName="GeneratorFunction",a(f,o,"GeneratorFunction"),a(d),a(d,o,"Generator"),a(d,n,function(){return this}),a(d,"toString",function(){return"[object Generator]"}),(i=function(){return{w:s,m:w}})()}function a(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}a=function(e,t,r,n){function i(t,r){a(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(i("next",0),i("throw",1),i("return",2))},a(e,t,r,n)}function s(e,t,r,n,o,i,a){try{var s=e[i](a),u=s.value}catch(e){return void r(e)}s.done?t(u):Promise.resolve(u).then(n,o)}function u(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var i=e.apply(t,r);function a(e){s(i,n,o,a,u,"next",e)}function u(e){s(i,n,o,a,u,"throw",e)}a(void 0)})}}function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,l(n.key),n)}}function l(e){var t=function(e){if("object"!=r(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==r(t)?t:t+""}e.r(t),e.d(t,{default:()=>b});var f,h,d,w=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.authCore=null,this.isInitialized=!1,this.webflowUser=null},t=[{key:"init",value:(p=u(i().m(function e(){return i().w(function(e){for(;;)switch(e.n){case 0:if(console.log("Initializing Niko CMS Integration..."),window.NikoAuthCore){e.n=1;break}throw console.error("NikoAuthCore not found. Make sure auth-core module is loaded first."),new Error("Auth core dependency missing");case 1:return this.authCore=window.NikoAuthCore,e.n=2,this.waitForAuthCore();case 2:if(this.setupAuthStateListener(),!this.authCore.isAuthenticated()){e.n=3;break}return e.n=3,this.loadWebflowUserData();case 3:this.isInitialized=!0,console.log("Niko CMS Integration initialized successfully");case 4:return e.a(2)}},e,this)})),function(){return p.apply(this,arguments)})},{key:"waitForAuthCore",value:(w=u(i().m(function e(){var t,r;return i().w(function(e){for(;;)switch(e.n){case 0:t=0,r=50;case 1:if(!(t<r)){e.n=4;break}if(!this.authCore.isInitialized()){e.n=2;break}return e.a(2);case 2:return e.n=3,new Promise(function(e){return setTimeout(e,100)});case 3:t++,e.n=1;break;case 4:throw new Error("Auth core not ready within timeout");case 5:return e.a(2)}},e,this)})),function(){return w.apply(this,arguments)})},{key:"setupAuthStateListener",value:function(){var e=this;this.authCore.getSupabaseClient().auth.onAuthStateChange,this.authCore.getSupabaseClient().auth.onAuthStateChange(function(){var t=u(i().m(function t(r,n){return i().w(function(t){for(;;)switch(t.n){case 0:if(console.log("CMS Integration detected auth state change:",r),"SIGNED_IN"!==r){t.n=2;break}return t.n=1,e.handleUserSignIn(n.user);case 1:t.n=3;break;case 2:"SIGNED_OUT"===r&&e.handleUserSignOut();case 3:return t.a(2)}},t)}));return function(e,r){return t.apply(this,arguments)}}())}},{key:"handleUserSignIn",value:(d=u(i().m(function e(t){var r;return i().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,console.log("CMS Integration handling user sign in:",t.email),e.n=1,this.loadWebflowUserData();case 1:if(this.webflowUser){e.n=2;break}return e.n=2,this.createWebflowUserRecord(t);case 2:e.n=4;break;case 3:e.p=3,r=e.v,console.error("Error handling user sign in for CMS:",r);case 4:return e.a(2)}},e,this,[[0,3]])})),function(e){return d.apply(this,arguments)})},{key:"handleUserSignOut",value:function(){console.log("CMS Integration handling user sign out"),this.webflowUser=null}},{key:"loadWebflowUserData",value:(h=u(i().m(function e(){var t,r,n,o;return i().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t=this.authCore.getCurrentUser(),r=this.authCore.getUserRole(),t){e.n=1;break}return console.log("No authenticated user for CMS integration"),e.a(2);case 1:return e.p=1,console.log("Loading Webflow user data for:",t.email),e.n=2,this.getWebflowUserByFirebaseUID(t.id,r);case 2:n=e.v,this.webflowUser=n.user,console.log("Webflow user data loaded:",this.webflowUser),e.n=4;break;case 3:e.p=3,o=e.v,console.warn("Failed to load Webflow user data:",o),this.webflowUser=null;case 4:return e.a(2)}},e,this,[[1,3]])})),function(){return h.apply(this,arguments)})},{key:"createWebflowUserRecord",value:(f=u(i().m(function e(t){var r,n,o,a,s;return i().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,console.log("Creating Webflow CMS record for:",t.email),o={name:(null===(r=t.user_metadata)||void 0===r?void 0:r.name)||t.email.split("@")[0],email:t.email,firebaseUid:t.id,userType:(null===(n=t.user_metadata)||void 0===n?void 0:n.user_type)||"Customer",isActive:!0,registrationDate:(new Date).toISOString()},e.n=1,this.callEdgeFunction("create-webflow-user",o);case 1:(a=e.v).success?(this.webflowUser=a.webflowRecord,console.log("Webflow CMS record created successfully:",this.webflowUser)):console.error("Failed to create Webflow CMS record:",a.error),e.n=3;break;case 2:e.p=2,s=e.v,console.error("Error creating Webflow CMS record:",s);case 3:return e.a(2)}},e,this,[[0,2]])})),function(e){return f.apply(this,arguments)})},{key:"getWebflowUserByFirebaseUID",value:(l=u(i().m(function e(t,r){var n,o;return i().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,this.callEdgeFunction("get-webflow-user",{firebaseUid:t,userType:r});case 1:if(!(n=e.v).success){e.n=2;break}return e.a(2,{user:n.webflowUser});case 2:throw new Error(n.error||"Failed to get Webflow user");case 3:e.n=5;break;case 4:throw e.p=4,o=e.v,console.error("Error getting Webflow user:",o),o;case 5:return e.a(2)}},e,this,[[0,4]])})),function(e,t){return l.apply(this,arguments)})},{key:"updateWebflowUserWishlist",value:(s=u(i().m(function e(t,r,n){var o,a;return i().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,this.callEdgeFunction("update-webflow-user-wishlist",{firebaseUid:t,userType:r,wishlistProducts:n});case 1:if(!(o=e.v).success){e.n=2;break}return this.webflowUser&&(this.webflowUser.wishlistProducts=n),e.a(2,o);case 2:throw new Error(o.error||"Failed to update wishlist");case 3:e.n=5;break;case 4:throw e.p=4,a=e.v,console.error("Error updating Webflow user wishlist:",a),a;case 5:return e.a(2)}},e,this,[[0,4]])})),function(e,t,r){return s.apply(this,arguments)})},{key:"callEdgeFunction",value:(a=u(i().m(function e(t,r){var n,o,a,s,u;return i().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=this.authCore.getSupabaseClient(),console.log("Calling Edge Function: ".concat(t),r),e.n=1,n.functions.invoke(t,{body:r});case 1:if(o=e.v,a=o.data,!(s=o.error)){e.n=2;break}throw console.error("Edge Function ".concat(t," error:"),s),s;case 2:return console.log("Edge Function ".concat(t," result:"),a),e.a(2,a);case 3:throw e.p=3,u=e.v,console.error("Failed to call Edge Function ".concat(t,":"),u),u;case 4:return e.a(2)}},e,this,[[0,3]])})),function(e,t){return a.apply(this,arguments)})},{key:"getWebflowUser",value:function(){return this.webflowUser}},{key:"getWishlist",value:function(){var e;return(null===(e=this.webflowUser)||void 0===e?void 0:e.wishlistProducts)||[]}},{key:"addToWishlist",value:(o=u(i().m(function e(t){var r,o,a;return i().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.authCore.isAuthenticated()&&this.webflowUser){e.n=1;break}throw new Error("User not authenticated or Webflow data not loaded");case 1:if(!(r=this.webflowUser.wishlistProducts||[]).includes(t)){e.n=2;break}return e.a(2,{success:!0,message:"Product already in wishlist"});case 2:return o=[].concat(n(r),[t]),e.p=3,e.n=4,this.updateWebflowUserWishlist(this.authCore.getCurrentUser().id,this.authCore.getUserRole(),o);case 4:return e.a(2,{success:!0,message:"Product added to wishlist"});case 5:return e.p=5,a=e.v,console.error("Failed to add to wishlist:",a),e.a(2,{success:!1,error:a.message})}},e,this,[[3,5]])})),function(e){return o.apply(this,arguments)})},{key:"removeFromWishlist",value:(r=u(i().m(function e(t){var r,n,o;return i().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.authCore.isAuthenticated()&&this.webflowUser){e.n=1;break}throw new Error("User not authenticated or Webflow data not loaded");case 1:return r=this.webflowUser.wishlistProducts||[],n=r.filter(function(e){return e!==t}),e.p=2,e.n=3,this.updateWebflowUserWishlist(this.authCore.getCurrentUser().id,this.authCore.getUserRole(),n);case 3:return e.a(2,{success:!0,message:"Product removed from wishlist"});case 4:return e.p=4,o=e.v,console.error("Failed to remove from wishlist:",o),e.a(2,{success:!1,error:o.message})}},e,this,[[2,4]])})),function(e){return r.apply(this,arguments)})}],t&&c(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,r,o,a,s,l,f,h,d,w,p}();if("undefined"!=typeof window){var p=new w;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){p.init().catch(console.error)}):setTimeout(function(){p.init().catch(console.error)},100),window.NikoCMSIntegration={getWebflowUser:function(){return p.getWebflowUser()},getWishlist:function(){return p.getWishlist()},addToWishlist:(d=u(i().m(function e(t){return i().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,p.addToWishlist(t);case 1:return e.a(2,e.v)}},e)})),function(e){return d.apply(this,arguments)}),removeFromWishlist:(h=u(i().m(function e(t){return i().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,p.removeFromWishlist(t);case 1:return e.a(2,e.v)}},e)})),function(e){return h.apply(this,arguments)}),isInitialized:function(){return p.isInitialized},callEdgeFunction:(f=u(i().m(function e(t,r){return i().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,p.callEdgeFunction(t,r);case 1:return e.a(2,e.v)}},e)})),function(e,t){return f.apply(this,arguments)})}}const b=w;return t})());